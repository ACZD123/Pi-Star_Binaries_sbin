#!/bin/bash
#
##############################################################################
#                                                                            #
#                         Pi-Star Find Modem Tool.                           #
#                                                                            #
#     Version 1.0, Code, Design and Development by Andy Taylor (MW0MWZ).     #
#                                                                            #
#              Make it simple to find the attached MMDVM Modem               #
#                                                                            #
##############################################################################
#
# Kill any MMDVMHost or DStarRepeater processes
if [[ $(/usr/bin/pgrep MMDVMHost) ]]; then
        systemctl stop mmdvmhost > /dev/null 2>&1
        svcRestart=mmdvmhost
fi
if [[ $(/usr/bin/pgrep dstarrepeaterd) ]]; then
        systemctl stop dstarrepeaterd > /dev/null 2>&1
        svcRestart=dstarrepeaterd
fi

# Find all the possible devices
for modemDevice in $(ls /dev/tty* | grep -E "tty(AMA|ACM|USB)."); do
        # Send the MMDVM command to get the ident string
        touch /tmp/ttyDump.dat
        stty -F ${modemDevice} 115200 raw -echo         # CONFIGURE SERIAL PORT
        exec 3<${modemDevice}                           # REDIRECT SERIAL OUTPUT TO FD 3
        cat <&3 >> /tmp/ttyDump.dat &                   # REDIRECT SERIAL OUTPUT TO FILE
        PID=$!                                          # SAVE PID TO KILL CAT
        echo -en '\xE0\x03\x00' > ${modemDevice}        # SEND COMMAND STRING TO SERIAL PORT
        sleep 0.2s                                      # WAIT FOR RESPONSE
        kill -9 $PID > /dev/null 2>&1                   # KILL CAT PROCESS
        exec 3<&- 1> /dev/stdout 2> /dev/null           # FREE FD 3

        # Do somthing with the output
        if [[ $(cat /tmp/ttyDump.dat | wc -c) -ge 1 ]]; then
                if [[ $(grep "MMDVM_HS" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyAMA"* ]]; then
                        echo -e "Detected MMDVM_HS (GPIO): ${modemDevice}"
                elif [[ $(grep "MMDVM_HS" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyACM"* ]]; then
                        echo -e "Detected MMDVM_HS (USB) : ${modemDevice}"
                elif [[ $(grep "MMDVM_HS" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyUSB"* ]]; then
                        echo -e "Detected MMDVM_HS (USB) : ${modemDevice}"
                elif [[ $(grep "MMDVM" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyAMA"* ]]; then
                        echo -e "Detected MMDVM (GPIO)   : ${modemDevice}"
                elif [[ $(grep "MMDVM" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyACM"* ]]; then
                        echo -e "Detected MMDVM (USB)    : ${modemDevice}"
                elif [[ $(grep "MMDVM" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyUSB"* ]]; then
                        echo -e "Detected MMDVM (USB)    : ${modemDevice}"
                elif [[ $(grep "DVMEGA" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyAMA"* ]]; then
                        echo -e "Detected DVMEGA (GPIO)  : ${modemDevice}"
                elif [[ $(grep "DVMEGA" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyACM"* ]]; then
                        echo -e "Detected DVMEGA (USB)   : ${modemDevice}"
                elif [[ $(grep "DVMEGA" /tmp/ttyDump.dat) && ${modemDevice} == *"ttyUSB"* ]]; then
                        echo -e "Detected DVMEGA (USB)   : ${modemDevice}"
                fi
                rm -rf /tmp/ttyDump.dat
        else
                rm -rf /tmp/ttyDump.dat
        fi
done

# Restart the service(s) if I stopped them
if [[ -v svcRestart ]]; then
        systemctl start ${svcRestart} > /dev/null 2>&1
fi
